<!DOCTYPE html>
<!--  lastBuildDate : Tue, 03 Apr 2018 14:22:13 +0200 -->
<html>
<head>
  
  
  <title>Mktd#1 Feign Vs Retrofit &#58; 2 Going Further</title>
  
  <!-- Meta -->
  <meta charset="utf-8">
  <meta http-equiv="content-language" content="en" />
  <meta name="language" content="en" />
  <!-- Google site verification -->
  <meta name="google-site-verification" content="Gq_ytzUtfYn95WsiH66e4Lfb8zANT-LUwD8JgH9xXdw" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="keywords" content="Expertise informatique, Dévelopement informatique" />

  <!-- RSS feed -->
  <link rel="alternate" type="application/rss+xml" title=" RSS Feed" href="http://www.monkeypatch.io/blog/feed.xml" />

  <!-- SEO -->
  <meta property="og:title" content="Mktd#1 Feign Vs Retrofit &#58; 2 Going Further" />

  
  <meta property="og:description" content="This article is the second of the serie REST clients in Java.

Previous article:
MKTD#1 : Getting started



Challenge #2: Going further…

The second challenge aims at solving advanced problems such as:


  Authentication and session management
  Errors management via Java Exception
  Files upload and download


" />
  <meta name="description" content="This article is the second of the serie REST clients in Java.

Previous article:
MKTD#1 : Getting started



Challenge #2: Going further…

The second challenge aims at solving advanced problems such as:


  Authentication and session management
  Errors management via Java Exception
  Files upload and download


" />
  
  
  
    <meta name="author" content="Emmanuel Vinas">
    <link rel="author" href="https://plus.google.com/+vinasemmanuel"/>
    
      <link rel="publisher" href="https://plus.google.com/+vinasemmanuel"/>
    
  
    <meta name="author" content="Igor Laborie">
    <link rel="author" href="https://plus.google.com/+IgorLaborie"/>
    
      <link rel="publisher" href="https://plus.google.com/+IgorLaborie"/>
    
  
    <meta name="author" content="Bruno Chauvet">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Arnaud bos">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Matthieu Caylet">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  
    <meta name="author" content="Alteanne Fernandez">
    <link rel="author" href="https://plus.google.com/"/>
    
      <link rel="publisher" href="https://plus.google.com/"/>
    
  

  
    <meta property="og:type" content="article"/>
    <meta property="og:article:published_time" content="2016-08-10T00:00:00+02:00">
    
      <meta property="og:article:author:username" content="Emmanuel Vinas">
    
      <meta property="og:article:author:username" content="Igor Laborie">
    
      <meta property="og:article:author:username" content="Bruno Chauvet">
    
      <meta property="og:article:author:username" content="Arnaud bos">
    
      <meta property="og:article:author:username" content="Matthieu Caylet">
    
      <meta property="og:article:author:username" content="Alteanne Fernandez">
    
    
    <meta property="og:article:tag" content="MKTD">
    
    <meta property="og:article:tag" content="Java">
    
    <meta property="og:article:tag" content="REST">
    
    <meta property="og:article:tag" content="Feign">
    
    <meta property="og:article:tag" content="Retrofit">
    
    <meta property="og:article:tag" content="Cookie">
    
  
  
  
  <meta property="og:image" content="http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png"/>

  <meta property="og:url" content="http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html"/>
  <meta property="og:site_name" content="MonkeyPatch"/>
  
  <!-- Twitter tags -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@MonkeyPatch_io" />
  <meta name="twitter:url" content="http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html">
  <meta name="twitter:title" content="Mktd#1 Feign Vs Retrofit &#58; 2 Going Further">
  <meta name="twitter:description" content="This article is the second of the serie REST clients in Java.

Previous article:
MKTD#1 : Getting started



Challenge #2: Going further…

The second challenge aims at solving advanced problems such as:


  Authentication and session management
  Errors management via Java Exception
  Files upload and download


">
  <meta name="twitter:image" content="http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png">

  <!-- Lang --> 
  <link rel="alternate" hreflang="en" href="http://www.monkeypatch.io/en/index" />
  <link rel="alternate" hreflang="fr" href="http://www.monkeypatch.io/index" />
  
  <meta property="og:locale:alternate" content="fr_FR"/>
  <meta property="og:locale" content="en_US"/>
  

  <link rel="shortcut icon" href="favicon.ico">
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

  <!-- Style -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
  <link id="theme-style" rel="stylesheet" href="/css/main.css">

 <script type="application/ld+json">
  {
    "@context": "http://schema.org",
    
      "@type": "BlogPosting", // 
      "mainEntityOfPage": "http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html", 
    
    "author": [
      
      { "@type": "Person", "name": "Emmanuel Vinas" },
      
      { "@type": "Person", "name": "Igor Laborie" },
      
      { "@type": "Person", "name": "Bruno Chauvet" },
      
      { "@type": "Person", "name": "Arnaud bos" },
      
      { "@type": "Person", "name": "Matthieu Caylet" },
      
      { "@type": "Person", "name": "Alteanne Fernandez" }
      
    ],
    "name": "MonkeyPatch",
    "headline": "Mktd#1 Feign Vs Retrofit &#58; 2 Going Further",
    "image": "http://www.monkeypatch.io/public/images/logos/logo-FeignVsRetrofit.png",
    
      "datePublished": "2016-08-10T00:00:00+02:00",
      "dateModified": "2016-08-10T00:00:00+02:00",
      "datePublished": "2016-08-10T00:00:00+02:00",
    
    "publisher": {
      "@type": "Organization",
      "name": "MonkeyPatch",
      "logo": "http://www.monkeypatch.io/public/images/logos/logo-mkp-blue-x256.png",
      "sameAs": [
        "https://twitter.com/monkeypatch_io","https://www.linkedin.com/company/monkeypatch-io"
      ]
    },
    "description": "Société de conseil et d'expertise en informatique spécialisée dans les nouvelles technologies.",
    "url": "http://www.monkeypatch.io/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html"
  }
</script>
</head>

<body class="post">
  <header>
  <div class="menu">
    <div class="logo">
      <a href="/en/index">
        <img alt="Monkey Patch" src="/public/images/logos/logo-monkey.svg">
      </a>
    </div>
    
    <nav class="lang">
      <ul>
        <li class="active">
          <a href="en/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html" >EN</a>
        </li>
        <li class="sep">|</li>
        <li class="">
          <a href="/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html" >FR</a>
        </li>
      </ul>
    </nav>
    
    <nav class="menu">
      <ul>
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li class="">
              <a href="/en/expert">Our expertise</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/about">Our thoughts</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/careers">Be a Monkey</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/job">Our Jobs</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/contact">Contact</a>
            </li>
          
        
        <li class="">
          <a href="/en/blog">Blog</a>
        </li>
      </ul>
    </nav>
      
    <nav class="hamburger">
      <label for="menu-hamburger">
        <i class="fa fa-bars" aria-hidden="true"></i>
      </label>
    </nav>
    
  </div>
  <input type="checkbox" id="menu-hamburger"/>
  <nav class="menu-hamburger">
     <ul>
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li class="">
              <a href="/en/expert">Our expertise</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/about">Our thoughts</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/careers">Be a Monkey</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/job">Our Jobs</a>
            </li>
          
        
          
            <li class="">
              <a href="/en/contact">Contact</a>
            </li>
          
        
        <li class="">
          <a href="/en/blog">Blog</a>
        </li>
      </ul>
      <ul class="lang">
        <li class="active">
          <a href="en/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html" >EN</a>
        </li>
        <li class="">
          <a href="/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html" >FR</a>
        </li>
      </ul>
  </nav>
</header>

  <main>
    <nav class="index"><!-- fill with JS --></nav>
    <section class="post">
      <h1 id="top">
        <span>Mktd#1 Feign Vs Retrofit &#58; 2 Going Further</span>
        <div class="share">
          <a class="twitter-share-button"
            href="https://twitter.com/share"
            data-size="large"
            data-via="monkeypatch_io"
            data-text="Mktd#1 Feign Vs Retrofit &#58; 2 Going Further"
            data-hashtags="MKTD,Java,REST,Feign,Retrofit,Cookie"
            >Tweet</a>
        </div>
      </h1>

      <span class="date">


  August 10, 2016

</span>

      <div class="tags">
        
          <span>MKTD</span>
        
          <span>Java</span>
        
          <span>REST</span>
        
          <span>Feign</span>
        
          <span>Retrofit</span>
        
          <span>Cookie</span>
        
      </div>

      <article><p>This article is the second of the serie <abbr title="REpresentational State Transfer">REST</abbr> clients in Java.</p>

<p>Previous article:
<a href="/2016/08/09/MKTD-1-feign-vs-retrofit-&amp;-58;-1-getting-started.html"><abbr title="MonkeyTechDays">MKTD</abbr>#1 : Getting started</a></p>

<hr />

<h2 id="challenge-2-going-further">Challenge #2: Going further…</h2>

<p>The second challenge aims at solving advanced problems such as:</p>

<ul>
  <li>Authentication and session management</li>
  <li>Errors management via Java <code class="highlighter-rouge">Exception</code></li>
  <li>Files <em>upload</em> and <em>download</em>
<!--more--></li>
</ul>

<h3 id="session-management-using-cookies">Session management using Cookies</h3>

<p>Out of the box, the server provides authentication and session management mechanisms using <a href="https://jwt.io/"><abbr title="Json WebToken">JWT</abbr></a> and <a href="https://tools.ietf.org/html/rfc6265">Cookies</a>. A new Java interface describes this operation:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AuthenticationApi</span> <span class="o">{</span>

    <span class="n">String</span> <span class="nf">login</span><span class="o">(</span><span class="n">LoginPassword</span> <span class="n">loginPassword</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The response <abbr title="HyperText Transfer Protocol">HTTP</abbr> may return a <code class="highlighter-rouge">Set-Cookie</code> header to be decoded. This <em>cookie</em> value will then be added to subsequent requests headers sent to other services.</p>

<blockquote>
  <p><em>Token</em> based solutions are simpler to put in place using Feign and Retrofit, but in our scenario we are not trying to follow the simplest approach. You can find more information on this topic on <a href="https://auth0.com/blog/angularjs-authentication-with-cookies-vs-token/">this blog</a>.</p>
</blockquote>

<h3 id="errors-management">Errors management</h3>

<p>Regarding errors management, we need to return specific errors based on the <abbr title="HyperText Transfer Protocol">HTTP</abbr> code returned by the server.
The following piece of code handles the <abbr title="HyperText Transfer Protocol">HTTP</abbr> error to Java exception mapping:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">RuntimeException</span> <span class="nf">decodeError</span><span class="o">(</span><span class="kt">int</span> <span class="n">status</span><span class="o">,</span> <span class="n">String</span> <span class="n">message</span><span class="o">,</span> <span class="n">Supplier</span><span class="o">&lt;</span><span class="n">RuntimeException</span><span class="o">&gt;</span> <span class="n">defaultCase</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">switch</span> <span class="o">(</span><span class="n">status</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">case</span> <span class="mi">404</span><span class="o">:</span> <span class="c1">// Not Found</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">NoSuchElementException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">case</span> <span class="mi">400</span><span class="o">:</span> <span class="c1">// Bad Request</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">case</span> <span class="mi">401</span><span class="o">:</span> <span class="c1">// Unauthorized</span>
        <span class="k">case</span> <span class="mi">403</span><span class="o">:</span> <span class="c1">// Forbidden</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">SecurityException</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="k">return</span> <span class="n">defaultCase</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h2 id="feign">Feign</h2>

<h3 id="pro-tip-http-requests-logging">Pro tip: <abbr title="HyperText Transfer Protocol">HTTP</abbr> requests logging</h3>

<p>To ease this challenge implementation, it appears to be very handy to log the <abbr title="HyperText Transfer Protocol">HTTP</abbr> requests and responses.</p>

<h4 id="quick--dirty-way">Quick &amp; Dirty way</h4>

<p>The quickest way to achieve this is to use a <code class="highlighter-rouge">RequestInterceptor</code> called by Feign before an <abbr title="HyperText Transfer Protocol">HTTP</abbr> request gets built and log it via <code class="highlighter-rouge">System.out</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">interceptor</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">)</span> <span class="c1">// Quick &amp; Dirty debug</span>
        <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>This obviously works only for <abbr title="HyperText Transfer Protocol">HTTP</abbr> requests, to achieve the same for the responses, similar thing has to be added to the decoder.</p>

<h4 id="using-feign-logger">Using Feign logger</h4>

<p>To avoid third-parties libraries dependencies, Feign defines its own <code class="highlighter-rouge">Logger</code>. It consists of an abstract class with a single method to implement.
The log level needs to be defined to allow log filtering later on (<code class="highlighter-rouge">NONE</code>, <code class="highlighter-rouge">BASIC</code>, <code class="highlighter-rouge">HEADERS</code>, <code class="highlighter-rouge">FULL</code>).
Here is an example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13</pre></td><td class="code"><pre><span class="n">Feign</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">logLevel</span><span class="o">(</span><span class="n">Logger</span><span class="o">.</span><span class="na">Level</span><span class="o">.</span><span class="na">FULL</span><span class="o">)</span>
        <span class="o">.</span><span class="na">logger</span><span class="o">(</span><span class="k">new</span> <span class="n">Logger</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">log</span><span class="o">(</span><span class="n">String</span> <span class="n">configKey</span><span class="o">,</span> <span class="n">String</span> <span class="n">format</span><span class="o">,</span> <span class="n">Object</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="s">"[%s] "</span><span class="o">,</span> <span class="n">configKey</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">printf</span><span class="o">(</span><span class="n">format</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">})</span>
        <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
        <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>By default, Feign logger class <code class="highlighter-rouge">feign.Logger.JavaLogger</code> relies on the <abbr title="Java Development Kit">JDK</abbr> logger <code class="highlighter-rouge">java.util.logging.Logger</code> but an extension exists to use other loggers such as <a href="https://github.com/OpenFeign/feign/tree/master/slf4j">SLF4J</a>.</p>

<h3 id="cookie-based-authentication">Cookie based Authentication</h3>

<p>The first step consists in retrieving the <em>cookie</em> generated by the authentication request. To do so, a specific decoder to handle the response headers and store them as <em>cookes</em> is used.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getAuthToken</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">AuthenticationApi</span> <span class="n">authenticationApi</span> <span class="o">=</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">((</span><span class="n">response</span><span class="o">,</span> <span class="n">type</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">handleCookies</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">headers</span><span class="o">()))</span> <span class="c1">// decode cookies</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">AuthenticationApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">authenticationApi</span><span class="o">.</span><span class="na">login</span><span class="o">(</span><span class="k">new</span> <span class="n">LoginPassword</span><span class="o">(</span><span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The <em>cookie</em> storage is managed by the <a href="https://docs.oracle.com/javase/8/docs/api/index.html?overview-summary.html">CookieManager</a> available since Java6.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">CookieManager</span> <span class="n">COOKIE_MANAGER</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieManager</span><span class="o">();</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The usage of this <code class="highlighter-rouge">CookieManager</code> is handled from the method <code class="highlighter-rouge">handleCookies</code> as follows:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">handleCookies</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
   <span class="c1">// From Map&lt;String, Collection&lt;String&gt;&gt; to Map&lt;String, List&lt;String&gt;&gt;</span>
   <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">h</span> <span class="o">=</span> <span class="n">headers</span><span class="o">.</span><span class="na">entrySet</span><span class="o">().</span><span class="na">stream</span><span class="o">()</span>
           <span class="o">.</span><span class="na">collect</span><span class="o">(</span>
             <span class="n">toMap</span><span class="o">(</span>
               <span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">::</span><span class="n">getKey</span><span class="o">,</span>
               <span class="n">entry</span> <span class="o">-&gt;</span> <span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">().</span><span class="na">stream</span><span class="o">().</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">()))</span>
            <span class="o">);</span>
   <span class="k">try</span> <span class="o">{</span>
       <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">BASE_URL</span><span class="o">);</span><span class="n">image</span>
       <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">h</span><span class="o">);</span>
       <span class="k">return</span> <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span> <span class="c1">// Stream&lt;HttpCookie&gt;</span>
               <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="s">"token"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cookie</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span>
               <span class="o">.</span><span class="na">findFirst</span><span class="o">()</span> <span class="c1">// Optional&lt;HttpCookie&gt;</span>
               <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">HttpCookie:</span><span class="o">:</span><span class="n">getValue</span><span class="o">)</span>
               <span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="o">(</span><span class="s">"Authentication cookie not found"</span><span class="o">));</span>
   <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>
<p>After being stored, this <em>cookie</em> is automatically sent back in subsequent requests.
This is achieved by using the <code class="highlighter-rouge">RequestInterceptor</code> mechanism that modifies the <code class="highlighter-rouge">RequestTemplate</code>. Feign uses this object to construct the <abbr title="HyperText Transfer Protocol">HTTP</abbr> request.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="kd">static</span> <span class="n">MonkeyRaceApi</span> <span class="nf">buildRaceApi</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">getAuthToken</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">addCookies</span><span class="o">)</span> <span class="c1">// Inject Cookies</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>The interceptor behaves as a <code class="highlighter-rouge">RequestTemplate</code> consumer:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">addCookies</span><span class="o">(</span><span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">URI</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">URI</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">BASE_URL</span><span class="o">);</span>
   <span class="n">COOKIE_MANAGER</span><span class="o">.</span><span class="na">getCookieStore</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">uri</span><span class="o">).</span><span class="na">stream</span><span class="o">()</span>
           <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">HttpCookie:</span><span class="o">:</span><span class="n">toString</span><span class="o">)</span>
           <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;</span> <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Cookie"</span><span class="o">,</span> <span class="n">cookie</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>With Feign, the <em>cookie</em> based authentication is closed to the <code class="highlighter-rouge">Authorization</code> header mechanism often associated to <abbr title="Json WebToken">JWT</abbr>. As it is based on <abbr title="HyperText Transfer Protocol">HTTP</abbr> headers, the same implementation approach using a <code class="highlighter-rouge">RequestInterceptor</code> can be used to handle authentication via <em>token</em>. On the other hand, using <em>cookies</em> makes the code more complex and impacts its readability.</p>

<blockquote>
  <p>We cam also use <code class="highlighter-rouge">feign.Target</code> to manage the authentication, see <a href="https://github.com/OpenFeign/feign#setting-headers-per-target">Feign documentation</a>.</p>
</blockquote>

<h3 id="errors-management-1">Errors management</h3>

<p>Feign proposes a specific errors management mechanism out of the box - if an <abbr title="HyperText Transfer Protocol">HTTP</abbr> reposnse code &gt;= 400. This is done using the <code class="highlighter-rouge">ErrorDecoder</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="kd">static</span> <span class="n">MonkeyRaceApi</span> <span class="nf">buildRaceApi</span><span class="o">(</span><span class="n">String</span> <span class="n">url</span><span class="o">,</span> <span class="n">String</span> <span class="n">login</span><span class="o">,</span> <span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
   <span class="n">getAuthToken</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">login</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
   <span class="k">return</span> <span class="n">builder</span>
           <span class="o">.</span><span class="na">errorDecoder</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">decodeError</span><span class="o">)</span> <span class="c1">// Decode errors</span>
           <span class="o">.</span><span class="na">requestInterceptor</span><span class="o">(</span><span class="nl">ApiFactory:</span><span class="o">:</span><span class="n">addCookies</span><span class="o">)</span> <span class="c1">// Inject Cookies</span>
           <span class="o">.</span><span class="na">decoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonDecoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">encoder</span><span class="o">(</span><span class="k">new</span> <span class="n">GsonEncoder</span><span class="o">())</span>
           <span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="n">MonkeyRaceApi</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">url</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">Exception</span> <span class="nf">decodeError</span><span class="o">(</span><span class="n">String</span> <span class="n">methodKey</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">decodeError</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">status</span><span class="o">(),</span> <span class="n">methodKey</span><span class="o">,</span>
            <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">FeignException</span><span class="o">.</span><span class="na">errorStatus</span><span class="o">(</span><span class="n">methodKey</span><span class="o">,</span> <span class="n">response</span><span class="o">));</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<blockquote>
  <p>Sometimes it can be useful to have a custom management of 404 errors. The <code class="highlighter-rouge">Decoder</code> method <code class="highlighter-rouge">feign.Feign.Builder#decode404</code> can be used to define the default baheviour.</p>
</blockquote>

<h3 id="upload">Upload</h3>

<p>File <em>upload</em> can be achieved in two different ways on the <abbr title="REpresentational State Transfer">REST</abbr> server:</p>

<ul>
  <li>Upload using a <a href="https://www.ietf.org/rfc/rfc2388.txt">formulaire multipart</a> and a request header <code class="highlighter-rouge">Content-type</code> set to <code class="highlighter-rouge">multipart/form-data</code>.</li>
  <li>Direct upload with the file content inside the request body and the request header <code class="highlighter-rouge">Content-type</code> set to <code class="highlighter-rouge">application/octet-stream</code>.</li>
</ul>

<p>The two approaches can be implemented using the same principle: a specific <code class="highlighter-rouge">Decoder</code>.
The second option is easier to set up as managing the <em>multipart</em> request body requires the usage of an external <abbr title="Application Programming Interface">API</abbr> such as <a href="https://commons.apache.org/proper/commons-fileupload/">Apache Commons FileUpload</a>
Other options are also available <a href="https://github.com/xxlabaza/feign-form">https://github.com/xxlabaza/feign-form</a> or <a href="https://github.com/pcan/feign-client-test">https://github.com/pcan/feign-client-test</a> to find implementation examples of the <em>multipart</em> approach.</p>

<p>So the second solution is much simpler, the main idea is to handle the specific case of objects of type <code class="highlighter-rouge">java.io.InputStream</code> and to delegate other cases to a traditional <abbr title="JavaScript Object Notation">JSON</abbr> encoder. To define the <abbr title="HyperText Transfer Protocol">HTTP</abbr> request body, the method <code class="highlighter-rouge">feign.RequestTemplate#body(byte[], java.nio.charset.Charset)</code> needs to be called.
It is possible to write the encoder body inside a <em>lambda</em> with Java 8, but it would be preferable to extract this implementation in a new class:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UploadEncoder</span> <span class="kd">implements</span> <span class="n">Encoder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Encoder</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UploadEncoder</span><span class="o">(</span><span class="n">Encoder</span> <span class="n">encoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">delegate</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">encode</span><span class="o">(</span><span class="n">Object</span> <span class="n">object</span><span class="o">,</span> <span class="n">Type</span> <span class="n">bodyType</span><span class="o">,</span> <span class="n">RequestTemplate</span> <span class="n">template</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">EncodeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">bodyType</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">template</span><span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">"Content-type"</span><span class="o">,</span> <span class="s">"application/octet-stream"</span><span class="o">);</span>
            <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">cast</span><span class="o">(</span><span class="n">object</span><span class="o">);</span>
            <span class="c1">// InputStream to byte[]</span>
            <span class="k">try</span> <span class="o">(</span><span class="n">BufferedInputStream</span> <span class="n">bin</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
                 <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">())</span> <span class="o">{</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">1024</span><span class="o">];</span>
                <span class="kt">int</span> <span class="n">bytesRead</span><span class="o">;</span>
                <span class="k">while</span> <span class="o">((</span><span class="n">bytesRead</span> <span class="o">=</span> <span class="n">bin</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="n">bos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="n">template</span><span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">(),</span> <span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">EncodeException</span><span class="o">(</span><span class="s">"Cannot upload file"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">delegate</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">object</span><span class="o">,</span> <span class="n">bodyType</span><span class="o">,</span> <span class="n">template</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<blockquote>
  <p>It is obviously possible to simplify this code by using a library to handle to conversion of <code class="highlighter-rouge">InputStream</code> into <code class="highlighter-rouge">byte[]</code>, but it does not hurt to write <code class="highlighter-rouge">try with resources</code> from time to time.</p>
</blockquote>

<blockquote>
  <p>It would be fair to say that this code may cause issues when working with large files. But in this scenario, we also need to ask the question: is a <abbr title="REpresentational State Transfer">REST</abbr> <abbr title="Application Programming Interface">API</abbr> the right solution to <em>upload</em> large files?</p>
</blockquote>

<h3 id="download">Download</h3>

<p>We use <code class="highlighter-rouge">feign.Decoder</code> to <em>download</em> files the same way we did for the <em>upload</em>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DownloadDecoder</span> <span class="kd">implements</span> <span class="n">Decoder</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Decoder</span> <span class="n">delegate</span><span class="o">;</span>

    <span class="n">DownloadDecoder</span><span class="o">(</span><span class="n">Decoder</span> <span class="n">decoder</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="n">delegate</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">decode</span><span class="o">(</span><span class="n">Response</span> <span class="n">response</span><span class="o">,</span> <span class="n">Type</span> <span class="n">type</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">DecodeException</span><span class="o">,</span> <span class="n">FeignException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">InputStream</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">asInputStream</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">delegate</span><span class="o">.</span><span class="na">decode</span><span class="o">(</span><span class="n">response</span><span class="o">,</span> <span class="n">type</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>Once again, Feign makes this operation quite simple as soon as the encoders/decoders are correctly used.</p>

<h3 id="summary">Summary</h3>

<p>Feign makes the handle of <abbr title="HyperText Transfer Protocol">HTTP</abbr> headers really simple, thus simplifying the authentication mechanisms using <em>cookies</em> or <em>tokens</em>.</p>

<p>Errors management with Feign is also trivial which is one of the key benefits over the usage of Retrofit.</p>

<p>Encoding mechanism provides an easy way to handle file <em>upload</em> and more generally to manage all the scenarios of requests serialising.
The decoding mechanism allows retrieving the content of a file that is <em>downloaded</em> and more generally deserialising <abbr title="HyperText Transfer Protocol">HTTP</abbr> responses.</p>

<p>Feign comes with a lot of flexibility using the <code class="highlighter-rouge">Encoder</code>, <code class="highlighter-rouge">Decoder</code>, <code class="highlighter-rouge">RequestInterceptor</code>, … and we can easily solve common issues we face with <abbr title="REpresentational State Transfer">REST</abbr> APIs.</p>

<h2 id="retrofit">Retrofit</h2>

<h3 id="cookie-based-authentication-1">Cookie based Authentication</h3>

<p>The easiest way to manage authentication with Retrofit is to use the internal of the <abbr title="HyperText Transfer Protocol">HTTP</abbr> client (<code class="highlighter-rouge">okHttp3</code>). Similarly to Feign we send an initial request to fetch the <em>cookie</em> and then reuse the same client for all subsequent requests.
Another option consists in using different clients for each requests but reusing the same <code class="highlighter-rouge">cookieJar</code>.</p>

<p>Here is a first basic implementation to understand the principle of a <code class="highlighter-rouge">cookieJar</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">cookieJar</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">CookieJar</span><span class="o">()</span> <span class="o">{</span>
                    <span class="kd">private</span> <span class="kd">final</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;&gt;</span> <span class="n">cookieStore</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">saveFromResponse</span><span class="o">(</span><span class="n">HttpUrl</span> <span class="n">url</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">cookieStore</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">uri</span><span class="o">().</span><span class="na">getAuthority</span><span class="o">(),</span> <span class="n">cookies</span><span class="o">);</span>
                        <span class="o">}</span>

                        <span class="nd">@Override</span>
                        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="nf">loadForRequest</span><span class="o">(</span><span class="n">HttpUrl</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">List</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;</span> <span class="n">cookies</span> <span class="o">=</span> <span class="n">cookieStore</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">uri</span><span class="o">().</span><span class="na">getAuthority</span><span class="o">());</span>
                            <span class="k">return</span> <span class="n">cookies</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">cookies</span> <span class="o">:</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Cookie</span><span class="o">&gt;();</span>
                    <span class="o">}</span>
                <span class="o">});</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>A more elegant implementation consists in adding the dependency <code class="highlighter-rouge">okhttp-urlconnection</code> from <code class="highlighter-rouge">OkHttp</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="n">CookieHandler</span> <span class="n">cookieHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CookieManager</span><span class="o">(</span>
            <span class="k">new</span> <span class="nf">PersistentCookieStore</span><span class="o">(</span><span class="n">ctx</span><span class="o">),</span> <span class="n">CookiePolicy</span><span class="o">.</span><span class="na">ACCEPT_ALL</span><span class="o">);</span>

<span class="n">OkHttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
            <span class="o">.</span><span class="na">cookieJar</span><span class="o">(</span><span class="k">new</span> <span class="n">JavaNetCookieJar</span><span class="o">(</span><span class="n">cookieHandler</span><span class="o">));</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="errors-management-2">Errors management</h3>

<p>There is no, from my point of view, any ideal solution with Retrofit to manage errors the way it is done with Feign.
In this example, we use the functionality of the <code class="highlighter-rouge">OkHttp</code> interceptor. There is still a limitation, the exceptions returned must be of type <code class="highlighter-rouge">RuntimeException</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OkHttpClient</span><span class="o">.</span><span class="na">Builder</span><span class="o">()</span>
        <span class="o">.</span><span class="na">addInterceptor</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">authInterceptor</span><span class="o">);</span>
</pre></td></tr></tbody></table>
</div>
</div>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="kd">private</span> <span class="n">Response</span> <span class="nf">authInterceptor</span><span class="o">(</span><span class="n">Interceptor</span><span class="o">.</span><span class="na">Chain</span> <span class="n">chain</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">request</span><span class="o">();</span>
    <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="na">proceed</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(!</span><span class="n">response</span><span class="o">.</span><span class="na">isSuccessful</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">RuntimeException</span> <span class="n">ex</span> <span class="o">=</span> <span class="n">ApiFactory</span><span class="o">.</span><span class="na">decodeError</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">code</span><span class="o">(),</span> <span class="n">response</span><span class="o">.</span><span class="na">message</span><span class="o">(),</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="kc">null</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">ex</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">;</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="upload-1">Upload</h3>

<p>To implement the <em>upload</em>, we have decided to use the method <a href="https://www.ietf.org/rfc/rfc2388.txt">multipart form</a> with the header <code class="highlighter-rouge">Content-type</code> set to <code class="highlighter-rouge">multipart/form-data</code>
Here is the implementation detail:</p>

<p>The method is added to the service</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonkeyService</span> <span class="o">{</span>

    <span class="nd">@Multipart</span>
    <span class="nd">@POST</span><span class="o">(</span><span class="s">"monkeys/{id}/photo"</span><span class="o">)</span>
    <span class="n">Call</span><span class="o">&lt;</span><span class="n">Photo</span><span class="o">&gt;</span> <span class="nf">sendPhoto</span><span class="o">(</span><span class="nd">@Path</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@Part</span> <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span> <span class="n">file</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>We create a temporary file containing the picture content, then we call the method <code class="highlighter-rouge">sendPhoto</code> giving it a <code class="highlighter-rouge">RequestBody</code> containing the temporary file to then create the <code class="highlighter-rouge">MultipartBody</code> passed down to the service.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">Photo</span> <span class="nf">savePhoto</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">InputStream</span> <span class="n">stream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">executeCall</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Path</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">Files</span><span class="o">.</span><span class="na">createTempFile</span><span class="o">(</span><span class="s">"exo2"</span><span class="o">,</span> <span class="s">"upload"</span><span class="o">);</span>
            <span class="n">Files</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span><span class="n">stream</span><span class="o">,</span> <span class="n">tmp</span><span class="o">,</span> <span class="n">REPLACE_EXISTING</span><span class="o">);</span>

            <span class="n">RequestBody</span> <span class="n">requestFile</span> <span class="o">=</span> <span class="n">RequestBody</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">"multipart/form-data"</span><span class="o">),</span> <span class="n">tmp</span><span class="o">.</span><span class="na">toFile</span><span class="o">());</span>
            <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span> <span class="n">body</span> <span class="o">=</span> <span class="n">MultipartBody</span><span class="o">.</span><span class="na">Part</span><span class="o">.</span><span class="na">createFormData</span><span class="o">(</span><span class="s">"photo"</span><span class="o">,</span> <span class="n">tmp</span><span class="o">.</span><span class="na">toFile</span><span class="o">().</span><span class="na">getName</span><span class="o">(),</span> <span class="n">requestFile</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">monkeyService</span><span class="o">.</span><span class="na">sendPhoto</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">body</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">});</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="download-1">Download</h3>

<p>Regarding the <em>download</em>, we only need to call our service by retrieving the reponse body. To do so, Retrofit proposes a <em>generic</em> type <code class="highlighter-rouge">ResponseBody</code> to access the raw response.</p>

<p>We start by adding this method to our service:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MonkeyService</span> <span class="o">{</span>
    <span class="nd">@GET</span><span class="o">(</span><span class="s">"monkeys/{id}/photo"</span><span class="o">)</span>
    <span class="n">Call</span><span class="o">&lt;</span><span class="n">ResponseBody</span><span class="o">&gt;</span> <span class="nf">downloadPhoto</span><span class="o">(</span><span class="nd">@Path</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span><span class="o">;</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<p>then here is the code to fetch the picture:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9</pre></td><td class="code"><pre><span class="nd">@Override</span>
<span class="kd">public</span> <span class="n">InputStream</span> <span class="nf">downloadPhoto</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SecurityException</span><span class="o">,</span> <span class="n">IllegalArgumentException</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">Response</span><span class="o">&lt;</span><span class="n">ResponseBody</span><span class="o">&gt;</span> <span class="n">response</span> <span class="o">=</span> <span class="n">monkeyService</span><span class="o">.</span><span class="na">downloadPhoto</span><span class="o">(</span><span class="n">id</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="na">body</span><span class="o">().</span><span class="na">byteStream</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table>
</div>
</div>

<h3 id="summary-1">Summary</h3>

<p>It is really simple with Retrofit to manage authentication via <em>cookies</em> and <em>tokens</em> as well as the files <em>upload</em> and <em>download</em>.</p>

<p>On the other side, errors management is far less intuitive. Maybe a better approach exists but we haven’t found it yet.</p>

<h2 id="overall-summary">Overall Summary</h2>

<p>Whether we used Feign or Retrofit, the management of <em>cookies</em> and files <em>upload</em>/<em>download</em> is easily implemented.</p>

<p>We also found that synchronous errors management is better managed with Feign than Retrofit.</p>

<p>Implementations using <a href="http://square.github.io/okhttp/">OkHttp</a> are common to Retrofit and Feign when the client <a href="https://github.com/OpenFeign/feign/tree/master/okhttp">okhttp-client</a> is used in Feign.</p>

</article>

      <div class="authors">
        
          <div class="author">
            <a href="https://twitter.com/EmmanuelVinas" rel="author">
              <img src="https://lh3.googleusercontent.com/-PPNaC_SZen8/AAAAAAAAAAI/AAAAAAAARt8/lRnd47vDjyM/s46-c-k-no/photo.jpg" alt="Emmanuel Vinas">
              <span>Emmanuel Vinas</span>
            </a>
          </div>
        
          <div class="author">
            <a href="https://twitter.com/ilaborie" rel="author">
              <img src="http://www.gravatar.com/avatar/5870075cc4934bb7c32f2a6c56cc4f8d?s=48" alt="Igor Laborie">
              <span>Igor Laborie</span>
            </a>
          </div>
        
          <div class="author">
            <a href="https://twitter.com/brunochauvet" rel="author">
              <img src="https://pbs.twimg.com/profile_images/504967695154954240/UlbmZ2uh_400x400.jpeg" alt="Bruno Chauvet">
              <span>Bruno Chauvet</span>
            </a>
          </div>
        
      </div>
    </section>

    
    <section class="comment">
      <div id="disqus_thread"></div>
      <script>
      var disqus_config = function () {
          this.page.url = "http://www.monkeypatch.io/en/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html";  // Replace PAGE_URL with your page's canonical URL variable
          this.page.identifier = "/2016/08/10/MKTD-1-feign-vs-retrofit-&-58;-2-going-further.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };
      (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = '//monkeypatchblog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </section>
    
    <footer class="top">
    <div>
      <h3>Get In Touch</h3>
      <p>
        <a class="contact" href="/encontact">
          <i class="fa fa-map-marker" aria-hidden="true"></i>
          <img src="/public/images/icons/Toulouse.png" alt="Toulouse">
        </a>
      </p>
      <p>
        <i class="fa fa-envelope-o" aria-hidden="true"></i>
        <a class="mail" href="mailto:contact@monkeypatch.io">contact@monkeypatch.io</a>
      </p>
    </div>
    <div class="social-network">
      <h3>Social Networks</h3>
      <ul class="social">
        <li>
          <a href="https://twitter.com/monkeypatch_io">
            <i class="fa fa-twitter" aria-hidden="true"></i>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/company/monkeypatch-io">
            <i class="fa fa-linkedin" aria-hidden="true"></i>
          </a>
        </li>
      </ul>
    </div>
  </div>
</footer>

<footer class="bottom">
  <div>
    Copyright @ 2016 MonkeyPatch -<a href="/en/terms">Terms and Conditions</a>
  </div>
  <div>
    Made with <i class="fa fa-heart" aria-hidden="true"></i> In Toulouse
  </div>
  <a class="goToTop" href="#top">
    <i class="fa fa-caret-up" aria-hidden="true"></i>
  </a>
</footer>

  </main>
  <!-- Google Tag Manager -->
  <noscript>
    <iframe src="//www.googletagmanager.com/ns.html?id=GTM-KGGFWH" height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
  <script>
    (function(w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(),
        event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        '//www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-KGGFWH');
  </script>
  <!-- End Google Tag Manager -->
  <script src="/public/scripts/modernizr-custom.js"></script>
  <script>
document.addEventListener('DOMContentLoaded', function () {
  var i;
  var nav = document.querySelector('nav.index');
  var headers = document.querySelectorAll('article h1, article h2, article h3, article h4, article h5, article h6');

  var createNavHeader = function(id, type, text) {
    var link = document.createElement('a');
    link.textContent = text;
    link.setAttribute('href', '#' + id);

    var text = document.createElement(type);
    text.appendChild(link);
    return text;
  };
  var createHeaderLink = function(id, text) {
    var link = document.createElement('a');
    link.classList.add('anchor');
    link.textContent = text;
    link.setAttribute('href', '#' + id);
    return link;
  };

  var processHeader = function(header) {
    var id = header.id;
    var tag = header.tagName;
    var text = header.textContent;

    var navHeader = createNavHeader(id, tag, text);
    nav.appendChild(navHeader);

    var headerLink = createHeaderLink(id, text);
    header.removeChild(header.firstChild);
    header.appendChild(headerLink);
  }

  for (i = 0; i < headers.length; i++) {
    processHeader(headers[i]);
  }
});
  </script>
  <!-- Share with Twitter -->
  <script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>
</body>
</html>
